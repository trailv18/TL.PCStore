
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .ui-w-40 {
        width: 40px !important;
        height: auto;
    }

    .card {
        box-shadow: 0 1px 15px 1px rgba(52,40,104,.08);
    }

    .ui-product-color {
        display: inline-block;
        overflow: hidden;
        margin: .144em;
        width: .875rem;
        height: .875rem;
        border-radius: 10rem;
        -webkit-box-shadow: 0 0 0 1px rgba(0,0,0,0.15) inset;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.15) inset;
        vertical-align: middle;
    }

    .form-control {
        width: 70px;
    }

    .btn-qty {
        border: 1px solid #f4f4f4;
        border-radius: 3px;
    }

    .btn-ud {
        border: none;
        background: none;
    }

    .disabled-link {
        pointer-events: none;
    }

    .btn-back{
        background:none;
        border:none;
        color: blue
    }
</style>

<div class="container px-3 my-5 clearfix">
    <div class="my-4 mx-3">
        <button type="button" class="btn-back" data-bs-toggle="modal" data-bs-target="#exampleModal" title="Quay lại giỏ hàng.">
            <i style="font-size:40px" class="fas fa-arrow-circle-left"></i>
        </button>
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Cảnh báo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Đang đặt hàng. Bạn có muốn quay lại?
                    </div>
                    <div class="modal-footer">
                        <button type="button" style="margin-right:10px" class="btn btn-secondary mr-3" data-bs-dismiss="modal">Đóng</button>
                        @Html.ActionLink("Quay lại", "cart", "order", null, htmlAttributes: new { @class = "btn btn-warning" })
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="py-3">
        <h2>Thanh toán</h2>
    </div>
        <div class="row">
            <div class="col-md-9">
                <div class="accordion" id="accordionExample">
                    <div hidden id="cartDataAll"></div>
                    <div class="card">
                        <div class="card-header" id="headingTwo">
                            <h2 class="mb-0">
                                <button class="btn collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Thông tin giao hàng
                                </button>
                            </h2>
                        </div>
                        <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="name">Tên:</label>
                                    <input style="width: 100%" type="text" value="@ViewBag.Name" id="name" class="form-control" required/>
                                </div>
                                <div class="form-group">
                                    <label for="mobile">Số điện thoại:</label>
                                    <input style="width: 100%" type="text" value="@ViewBag.Mobile" id="mobile" class="form-control" required />
                                </div>
                                <div class="form-group">
                                    <label for="address">Địa chỉ:</label>
                                    <input style="width: 100%" type="text" value="@ViewBag.UserAddress" id="address" class="form-control" required/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" id="headingThree">
                            <h2 class="mb-0">
                                <button class="btn collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    Phương thức thanh toán
                                </button>
                            </h2>
                        </div>
                        <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" value="shipcode" name="payment" id="shipcode" />
                                    <label class="form-check-label" for="shipcode">Thanh toán khi nhận hàng.</label>

                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" value="online" name="payment" id="online">
                                    <label class="form-check-label" for="online">Thanh toán online.</label>
                                </div>

                                <!--<div id="collapseFour" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
                                <div class="card-body border-bottom">
                                    <script src="https://www.paypal.com/sdk/js?client-id=Aa8ZMQ959kPBV_aazpg1LLjyZIyrkFHLvIfF7st-a2ok0Q2YRmbpSXn3mlSA2fFRJbWuWYo_KdIUeNEX">
                                    </script>

                                    <div id="paypal-button-container"></div>
                                    <div class="d-none">
                                        <span id="total"> </span>
                                    </div>-->
                                <!-- Add the checkout buttons, set up the order and approve the order -->
                                <!--<script>
                                            var total = document.getElementById("total").innerText;

                                            paypal.Buttons({
                                                createOrder: function (data, actions) {
                                                    return actions.order.create({
                                                        purchase_units: [{
                                                            amount: {
                                                                value: total
                                                            }
                                                        }]
                                                    });
                                                },
                                                onApprove: function (data, actions) {
                                                    return actions.order.capture().then(function (details) {
                                                        alert("Thanh toán thành công!");
                                                    });
                                                }
                                            }).render('#paypal-button-container'); // Display payment options on your web page
                                        </script>
                                    </div>
                                </div>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="bottom:0; height: 150px" class="col-md-3 card">
                <div class="mt-5 d-flex justify-content-end">
                    <label class="text-muted font-weight-normal m-0">Tổng tiền: </label>
                    <div style="margin-left: 10px" class="text-large"><strong id="allTotal"></strong></div>
                </div>

                <div class="d-flex justify-content-end">
                    <input id="btnCheckOut" type="button" class="btn btn-success mt-2" disabled value="Thanh toán" onclick="checkOut()" />
                </div>
            </div>
        </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

<script>

    $(document).ready(function () {
        loadDataToTable();
    });

    function checkOut() {
        let name = document.getElementById("name").value;
        let mobile = document.getElementById("mobile").value;
        let address = document.getElementById("address").value;
        let payment = document.getElementsByName("payment")[0].value

        let productLocal = [];
        productLocal = JSON.parse(localStorage.getItem('products'));

        var arrProduct = new Array();
        var counter = 0;

        for (var i = 0; i < productLocal.length; i++) {

            arrProduct[counter] = { ProductId: productLocal[i].id, Qty: productLocal[i].qty, Price: productLocal[i].price };
            counter++;

        }

        console.log(name, mobile, address, payment);
        
        $.ajax({
            url: "/order/checkOut",
            data: { products: arrProduct, name: name, mobile: mobile, address: address, payment:payment },
            type: "POST",
            success: function (result) {
                alert("Đặt hàng thành công!");
                localStorage.clear();
                window.location.replace("https://localhost:44388/");
            },
            error: function (errormessage) {
                alert(errormessage.responseText);
            }
        });
    }

</script>